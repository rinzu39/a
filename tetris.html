<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>TETRIS</title>
<style>
body { font-family:sans-serif; text-align:center; background:#111; color:#fff; margin:0; padding:0; }
#game {
  width: 95vw;        
  height: 90vh;       
  max-width: 1000px;
  max-height: 1600px;
  margin: 20px auto;
  background:#222;
  position:relative;
  border:3px solid #fff;
  touch-action:none;
  overflow:hidden;
}
.block { position:absolute; transition: top 0.1s, left 0.1s; }
#score { font-size:22px; margin:10px; }
#nameArea { margin:10px; }
#controls {
  margin-top:10px;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
}
button {
  padding:20px 25px;
  margin:10px;
  font-size:22px;
  border-radius:12px;
  cursor:pointer;
}
input[type=range] { width:120px; height:10px; margin:5px 0; }
#audioControls { margin-top:10px; }
</style>
</head>
<body>
<h1>TETRIS</h1>
<div id="nameArea">
  <input type="text" id="nameInput" placeholder="名前を入力">
  <button onclick="startGame()">ゲーム開始</button>
</div>
<div id="score"></div>
<div id="game"></div>
<div id="controls">
  <button onclick="moveLeft()">← 左</button>
  <button onclick="rotate()">⟳ 回転</button>
  <button onclick="moveRight()">→ 右</button>
  <button onclick="moveDownFast()">↓ 下</button>
  <button onclick="holdBlock()">H ホールド</button>
  <button onclick="changeTheme()">テーマ切替</button>
</div>
<div id="audioControls">
  <button onclick="toggleBGM()">BGM ON/OFF</button>
  <div>BGM音量: <input type="range" id="volumeBGM" min="0" max="1" step="0.05" value="0.5"></div>
  <div>効果音: <input type="range" id="volumeSE" min="0" max="1" step="0.05" value="0.5"></div>
</div>

<script>
let COLS=12, ROWS=20;
let game=document.getElementById("game");
let BLOCK = Math.min(game.clientWidth/COLS, game.clientHeight/ROWS);
let grid = Array.from({length:ROWS}, ()=>Array(COLS).fill(0));
let current, currentX, currentY, hold=null;
let score=0, linesCleared=0, level=1, interval=1000, fallTimer;
let playerName="", touchStartX=0, touchStartY=0, currentTheme=0, currentColor="cyan";

// 音声
let bgm = new Audio("audio/bgm.mp3"); bgm.loop=true; bgm.volume=0.5;
function playLineSound(){ let s=new Audio("audio/line.mp3"); s.volume=document.getElementById("volumeSE").value; s.play(); }

// テーマ
const themes=[
  { bg:"#111", colors:["cyan","yellow","orange","red","green","blue","purple"] },
  { bg:"linear-gradient(180deg,#001,#334)", colors:["#ff6","#6ff","#f6f","#f60","#0ff","#f0f","#0f0"] },
  { bg:"linear-gradient(180deg,#000022,#220033)", colors:["#8cf","#fc8","#c8f","#f88","#8f8","#88f","#ff8"] },
  { bg:"linear-gradient(180deg,#ff0,#f0f)", colors:["#ff0","#f0f","#0ff","#0f0","#f60","#6f0","#0f6"] }
];

// 形状
const shapes=[
  [[1,1,1,1]], 
  [[1,1],[1,1]], 
  [[0,1,0],[1,1,1]], 
  [[1,1,0],[0,1,1]], 
  [[0,1,1],[1,1,0]]
];

function startGame(){
  let input=document.getElementById("nameInput").value;
  playerName=input?input:"名無し";
  document.getElementById("nameArea").style.display="none";
  score=0; linesCleared=0; level=1;
  spawn(); draw();
  fallTimer=setInterval(moveDown, interval);
  bgm.play();
}

function spawn(){
  current=shapes[Math.floor(Math.random()*shapes.length)];
  currentX=Math.floor(COLS/2)-2; currentY=0;
  currentColor=themes[currentTheme].colors[Math.floor(Math.random()*themes[currentTheme].colors.length)];
  if(collide(currentX,currentY)){ alert(playerName+"のゲームオーバー！スコア:"+score); location.reload(); }
}

function collide(x,y){
  for(let i=0;i<current.length;i++){
    for(let j=0;j<current[i].length;j++){
      if(current[i][j]){
        let newX=x+j,newY=y+i;
        if(newX<0||newX>=COLS||newY>=ROWS) return true;
        if(grid[newY][newX]) return true;
      }
    }
  }
  return false;
}

function freeze(){
  for(let i=0;i<current.length;i++){
    for(let j=0;j<current[i].length;j++){
      if(current[i][j]) grid[currentY+i][currentX+j]=currentColor;
    }
  }
  clearLines(); spawn();
}

function clearLines(){
  let linesToClear=[];
  for(let y=ROWS-1;y>=0;y--){ if(grid[y].every(cell=>cell)) linesToClear.push(y); }
  if(linesToClear.length>0){
    playLineSound();
    linesToClear.forEach(y=>grid.splice(y,1));
    linesToClear.forEach(_=>grid.unshift(Array(COLS).fill(0)));
    score+=10*linesToClear.length;
    linesCleared+=linesToClear.length;
    if(linesCleared%5===0){ level++; interval=Math.max(100,interval-100); clearInterval(fallTimer); fallTimer=setInterval(moveDown,interval);}
  }
  updateScore();
}

function updateScore(){ document.getElementById("score").innerText=playerName+"のスコア:"+score+"  レベル:"+level; }

function moveDown(){ if(!collide(currentX,currentY+1)) currentY++; else freeze(); draw(); }
function moveDownFast(){ currentY++; moveDown(); }
function moveLeft(){ if(!collide(currentX-1,currentY)) { currentX--; draw(); } }
function moveRight(){ if(!collide(currentX+1,currentY)) { currentX++; draw(); } }
function rotate(){ let temp=current[0].map((_,i)=>current.map(row=>row[i])).reverse(); let old=current; current=temp; if(collide(currentX,currentY)) current=old; draw(); }
function holdBlock(){ if(!hold){ hold=current; spawn(); } else {[current,hold]=[hold,current]; currentX=Math.floor(COLS/2)-2; currentY=0;} draw(); }
function changeTheme(){ currentTheme=(currentTheme+1)%themes.length; draw(); }

function draw(){
  BLOCK = Math.min(game.clientWidth/COLS, game.clientHeight/ROWS);
  game.innerHTML="";
  game.style.background=themes[currentTheme].bg;
  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      if(grid[y][x]){
        let div=document.createElement("div");
        div.className="block";
        div.style.width=BLOCK+"px";
        div.style.height=BLOCK+"px";
        div.style.top=y*BLOCK+"px";
        div.style.left=x*BLOCK+"px";
        div.style.background=grid[y][x];
        game.appendChild(div);
      }
    }
  }
  if(current){
    for(let y=0;y<current.length;y++){
      for(let x=0;x<current[y].length;x++){
        if(current[y][x]){
          let div=document.createElement("div");
          div.className="block";
          div.style.width=BLOCK+"px";
          div.style.height=BLOCK+"px";
          div.style.top=(currentY+y)*BLOCK+"px";
          div.style.left=(currentX+x)*BLOCK+"px";
          div.style.background=currentColor;
          game.appendChild(div);
        }
      }
    }
  }
}

// スワイプ操作
game.addEventListener('touchstart',e=>{ touchStartX=e.touches[0].clientX; touchStartY=e.touches[0].clientY; }, false);
game.addEventListener('touchend',e=>{
  let dx=e.changedTouches[0].clientX-touchStartX;
  let dy=e.changedTouches[0].clientY-touchStartY;
  if(Math.abs(dx)>Math.abs(dy)){ if(dx>20) moveRight(); else if(dx<-20) moveLeft(); }
  else{ if(dy<-20) rotate(); else if(dy>20) moveDownFast(); }
}, false);

// 音量操作
document.getElementById("volumeBGM").addEventListener("input",e=>bgm.volume=e.target.value);
document.getElementById("volumeSE").addEventListener("input",e=>{});
function toggleBGM(){ bgm.paused?bgm.play():bgm.pause(); }

</script>
</body>
</html>