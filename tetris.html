<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>TETRIS</title>
<style>
body {
  font-family: sans-serif;
  text-align: center;
  margin: 0;
  padding: 0;
  overflow-x: hidden;
}
#game {
  width: 1080px;
  height: 2432px;
  margin: auto;
  position: relative;
  border: 2px solid #fff;
  touch-action: none;
}
.block {
  width: 108px;
  height: 108px;
  position: absolute;
  box-sizing: border-box;
  border: 1px solid #000;
  transition: background 0.2s;
}
#score,#level {
  font-size: 48px;
  margin: 20px;
}
#controls button {
  width: 150px;
  height: 150px;
  font-size: 48px;
  margin: 10px;
  border-radius: 20px;
}
input[type=range] {
  width: 300px;
  margin: 10px;
}
</style>
</head>
<body>

<h1>TETRIS</h1>
<div id="nameArea">
  <input type="text" id="nameInput" placeholder="名前を入力">
  <button onclick="startGame()">ゲーム開始</button>
</div>
<div id="score"></div>
<div id="level"></div>
<div id="game"></div>

<div id="controls">
  <button onclick="moveLeft()">← 左</button>
  <button onclick="rotate()">⟳ 回転</button>
  <button onclick="moveRight()">→ 右</button>
  <button onclick="moveDown()">↓ 下</button>
  <button onclick="holdBlock()">H ホールド</button>
</div>

<div>
  テーマ:
  <button onclick="setTheme(0)">ダーク</button>
  <button onclick="setTheme(1)">ライト</button>
  <button onclick="setTheme(2)">ネオン</button>
  <button onclick="setTheme(3)">宇宙</button>
  <button onclick="setTheme(4)">レトロ</button>
</div>

<div>
  BGM 音量: <input type="range" id="bgmVolume" min="0" max="1" step="0.1" value="0.5">
  効果音音量: <input type="range" id="seVolume" min="0" max="1" step="0.1" value="0.5">
</div>

<audio id="bgm" loop src="bgm.mp3"></audio>
<audio id="se" src="se.mp3"></audio>

<script>
let game = document.getElementById("game");
const COLS=10, ROWS=20, BLOCK=108;
let grid = Array.from({length:ROWS}, ()=>Array(COLS).fill(0));
let current, currentX, currentY, score=0, level=1, linesCleared=0;
let heldBlock=null, canHold=true;
let currentColor;
let playerName="";
let touchStartX=0,touchStartY=0;

// 音
const bgm=document.getElementById("bgm");
const se=document.getElementById("se");
document.getElementById("bgmVolume").oninput=e=>{bgm.volume=e.target.value;}
document.getElementById("seVolume").oninput=e=>{se.volume=e.target.value;}

// テトリス形状
const shapes=[
  [[1,1,1,1]], // I
  [[1,1],[1,1]], // O
  [[0,1,0],[1,1,1]], // T
  [[1,1,0],[0,1,1]], // S
  [[0,1,1],[1,1,0]], // Z
  [[1,0,0],[1,1,1]], // J
  [[0,0,1],[1,1,1]]  // L
];

// テーマ定義
const themes=[
  {bg:"linear-gradient(to bottom,#222,#000)",colors:["cyan","yellow","magenta","green","red","blue","orange"]},
  {bg:"linear-gradient(to bottom,#fff,#aaf)",colors:["#f00","#0f0","#00f","#ff0","#f0f","#0ff","#aaa"]},
  {bg:"linear-gradient(to bottom,#111,#333)",colors:["#0ff","#f0f","#ff0","#f0f","#0ff","#ff0","#f0f"]},
  {bg:"linear-gradient(to bottom,#001,#112)",colors:["#33f","#66f","#99f","#ccf","#f0f","#88f","#44f"]},
  {bg:"linear-gradient(to bottom,#ccc,#999)",colors:["#f88","#8f8","#88f","#ff8","#f8f","#8ff","#888"]}
];
let currentTheme=0;
setTheme(0);

// ゲーム開始
function startGame(){
  let input=document.getElementById("nameInput").value;
  playerName=input?input:"名無し";
  document.getElementById("nameArea").style.display="none";
  document.getElementById("score").innerText=playerName+"のスコア: 0";
  document.getElementById("level").innerText="レベル: 1";
  spawn();
  draw();
  bgm.play();
  window.gameInterval=setInterval(moveDown,2000);
}

// テーマ切替
function setTheme(index){
  currentTheme=index;
  game.style.background=themes[index].bg;
}

// 描画
function draw(){
  game.innerHTML="";
  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      if(grid[y][x]){
        let div=document.createElement("div");
        div.className="block";
        div.style.top=y*BLOCK+"px";
        div.style.left=x*BLOCK+"px";
        div.style.background=grid[y][x];
        game.appendChild(div);
      }
    }
  }
  if(current){
    for(let y=0;y<current.length;y++){
      for(let x=0;x<current[y].length;x++){
        if(current[y][x]){
          let div=document.createElement("div");
          div.className="block";
          div.style.top=(currentY+y)*BLOCK+"px";
          div.style.left=(currentX+x)*BLOCK+"px";
          div.style.background=currentColor;
          game.appendChild(div);
        }
      }
    }
  }
}

// 新ブロック生成
function spawn(){
  let idx=Math.floor(Math.random()*shapes.length);
  current=shapes[idx];
  currentColor=themes[currentTheme].colors[idx];
  currentX=3;currentY=0;
  canHold=true;
  if(collide(currentX,currentY)){
    alert(playerName+"のゲームオーバー！スコア:"+score);
    clearInterval(window.gameInterval);
    location.reload();
  }
}

// 衝突判定
function collide(x,y){
  for(let i=0;i<current.length;i++){
    for(let j=0;j<current[i].length;j++){
      if(current[i][j]){
        let newX=x+j,newY=y+i;
        if(newX<0||newX>=COLS||newY>=ROWS) return true;
        if(grid[newY][newX]) return true;
      }
    }
  }
  return false;
}

// 固定
function freeze(){
  for(let i=0;i<current.length;i++){
    for(let j=0;j<current[i].length;j++){
      if(current[i][j]) grid[currentY+i][currentX+j]=currentColor;
    }
  }
  clearLines();
  spawn();
}

// ライン削除
let linesCleared=0;
function clearLines(){
  for(let y=ROWS-1;y>=0;y--){
    if(grid[y].every(c=>c)){
      grid.splice(y,1);
      grid.unshift(Array(COLS).fill(0));
      linesCleared++;
      score+=10;
      se.play();
      if(linesCleared%5===0){
        level++;
        clearInterval(window.gameInterval);
        window.gameInterval=setInterval(moveDown,Math.max(2000-(level-1)*200,200));
        document.getElementById("level").innerText="レベル: "+level;
      }
      document.getElementById("score").innerText=playerName+"のスコア: "+score;
      y++;
    }
  }
}

// 下移動
function moveDown(){if(!collide(currentX,currentY+1)) currentY++; else freeze(); draw();}

// 左右回転操作
function moveLeft(){if(!collide(currentX-1,currentY)){currentX--;draw();}}
function moveRight(){if(!collide(currentX+1,currentY)){currentX++;draw();}}
function rotate(){let temp=current[0].map((_,i)=>current.map(r=>r[i])).reverse();let old=current;current=temp;if(collide(currentX,currentY)) current=old;draw();}

// ホールド
let heldBlock=null,canHold=true;
function holdBlock(){
  if(!canHold) return;
  let temp=current,tempColor=currentColor;
  if(heldBlock){
    current=heldBlock.block;
    currentColor=heldBlock.color;
  } else {
    spawn();
  }
  heldBlock={block:temp,color:tempColor};
  canHold=false;
  draw();
}

// スワイプ操作
game.addEventListener('touchstart',e=>{touchStartX=e.touches[0].clientX;touchStartY=e.touches[0].clientY;},false);
game.addEventListener('touchend',e=>{
  let dx=e.changedTouches[0].clientX-touchStartX;
  let dy=e.changedTouches[0].clientY-touchStartY;
  if(Math.abs(dx)>Math.abs(dy)){
    if(dx>20) moveRight(); else if(dx<-20) moveLeft();
  } else {
    if(dy<-20) rotate(); else if(dy>20) moveDown();
  }
},false);
</script>
</body>
</html>